name: Daily Watchdog

on:
  workflow_dispatch:
  schedule:
    - cron: "45 23 * * *"

permissions:
  contents: read
  issues: write

concurrency:
  group: daily-watchdog
  cancel-in-progress: false

defaults:
  run:
    working-directory: watchlist

jobs:
  watchdog:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Run watchdog checks
        id: checks
        continue-on-error: true
        env:
          WATCHDOG_REQUIRE_NOTIFICATION: ${{ vars.WATCHDOG_REQUIRE_NOTIFICATION }}
        run: |
          ARGS=(
            --positions-path data/positions.json
            --last-run-path out/last_run.json
            --max-run-age-hours 36
            --max-notification-age-hours 36
          )

          if [ "${WATCHDOG_REQUIRE_NOTIFICATION}" = "true" ]; then
            ARGS+=(--require-notification)
          fi

          python -m src.ops.watchdog "${ARGS[@]}"

      - name: Open watchdog issue
        if: steps.checks.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const title = "Watchdog alert: daily pipeline stale";
            const label = "watchdog";
            const body =
              `Watchdog detected stale daily automation on ${new Date().toISOString()}.\n\n` +
              `Run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const { owner, repo } = context.repo;

            try {
              await github.rest.issues.getLabel({ owner, repo, name: label });
            } catch (error) {
              if (error.status === 404) {
                await github.rest.issues.createLabel({
                  owner,
                  repo,
                  name: label,
                  color: "B60205",
                  description: "Automation watchdog alerts"
                });
              } else {
                throw error;
              }
            }

            const openIssues = await github.paginate(github.rest.issues.listForRepo, {
              owner,
              repo,
              state: "open",
              labels: label,
              per_page: 100
            });
            const existing = openIssues.find((issue) => issue.title === title);
            if (!existing) {
              await github.rest.issues.create({
                owner,
                repo,
                title,
                body,
                labels: [label]
              });
            }

      - name: Fail workflow when stale
        if: steps.checks.outcome == 'failure'
        run: exit 1
